<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Solera — Dashboard</title>
  <style>
    :root{
      --bg:#f7f9fc; --paper:#fff; --ink:#0f172a; --muted:#6b7280;
      --border:#e8ecf3; --shadow:0 20px 50px rgba(10,20,30,.08);

      /* KPI gradient + tokens */
      --grad-purple: linear-gradient(90deg, rgb(60,0,130), rgb(100,20,200), rgb(156,54,255));
      --ink-strong: #0b1324;
      --ink-soft: #5b667a;
      --ring: #e8ecf3;
      --surface: #ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .screen{display:none;min-height:100vh}
    .screen.active{display:block}

    /* ===== Portada ===== */
    .hero-landing{
      position:relative;
      min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      background:#fff; padding:40px 24px;
      overflow:hidden;
    }
    .watermark-bg{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      pointer-events:none; user-select:none; z-index:0;
      font-weight:900; text-transform:uppercase; letter-spacing:8px;
      color:#e5e7eb; opacity:.75; line-height:1;
      font-size:240px; white-space:nowrap; transform:translateY(6%);
    }
    @media (max-width:1200px){ .watermark-bg{font-size:200px} }
    @media (max-width:900px){  .watermark-bg{font-size:160px; transform:translateY(8%)} }
    @media (max-width:600px){  .watermark-bg{font-size:120px; transform:translateY(10%)} }

    .landing-wrap{ position:relative; z-index:1; max-width:980px; width:100%; display:flex; flex-direction:column; align-items:center; text-align:center; }
    .landing-title{ font-weight:900; letter-spacing:1px; line-height:1.0; margin:0 0 18px; color:#2b2f33; text-transform:uppercase; font-size:64px; text-shadow:0 2px 0 rgba(255,255,255,0.6); }
    @media (max-width:900px){ .landing-title{font-size:48px} }
    @media (max-width:600px){ .landing-title{font-size:38px} }

    .landing-visual{ margin:18px 0 20px; max-width:520px; width:100%; filter: drop-shadow(0 18px 40px rgba(0,0,0,.12)); }
    .landing-visual img{ width:100%; height:auto; display:block; object-fit:contain; }
    .landing-cta{ display:flex; gap:16px; margin-top:10px; flex-wrap:wrap; justify-content:center; }
    .btn-dark{ background:#16181b; color:#fff; border:0; padding:12px 18px; border-radius:10px; cursor:pointer; font-weight:700; letter-spacing:.3px; box-shadow:0 10px 24px rgba(22,24,27,.18); }
    .btn-dark:hover{ transform:translateY(-1px) }

    /* ===== Nav (dashboard) ===== */
    .nav{position:sticky;top:0;z-index:10;background:var(--paper);border-bottom:1px solid var(--border);
      display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 20px;
      box-shadow:0 6px 20px rgba(17,17,26,.05)}
    .nav a{color:var(--ink);text-decoration:none;border:1px solid var(--border);border-radius:10px;padding:8px 12px;background:linear-gradient(#fff,#f8f9ff)}

    /* ===== Layout dashboard ===== */
    .container{max-width:1280px;margin:0 auto;padding:32px}
    .grid-12{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:16px}
    .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-5{grid-column:span 5}
    .col-6{grid-column:span 6}.col-7{grid-column:span 7}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    .card2{background:var(--paper);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .card-pad{padding:18px}
    .viz{min-height:280px;border:1px solid var(--border);border-radius:16px;background:#fff;box-shadow:inset 0 1px 0 rgba(255,255,255,.6),0 6px 20px rgba(17,17,26,.04)}
    .title{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.6px}

    /* ===== Login ===== */
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:420px;background:#fff;border:1px solid var(--border);border-radius:14px;padding:26px;box-shadow:var(--shadow)}
    label{display:block;font-size:13px;color:#333;margin-bottom:6px}
    input[type=text],input[type=password]{width:100%;padding:12px 14px;border:1px solid #e6e9ee;border-radius:8px;margin-bottom:12px}
    .btn{background:#111;color:#fff;padding:12px 20px;border-radius:10px;border:none;cursor:pointer;font-weight:700;letter-spacing:.3px}
    .btn.secondary{background:transparent;color:var(--ink);border:1px solid var(--border)}
    .error{color:#b00020;font-size:13px;display:none;margin-top:6px}

    /* ===== KPI cards (fila 1, estilo moderno + hover morado) ===== */
    .kpi-row{ display:grid; grid-template-columns:repeat(12,minmax(0,1fr)); gap:16px; }
    .kpi-card{
      grid-column: span 3;
      position:relative;
      border-radius:18px;
      background: var(--surface);
      border: 1px solid var(--ring);
      box-shadow: 0 10px 24px rgba(17,23,39,.06);
      padding: 22px 22px 20px;
      transition: all .35s ease;
      overflow:hidden;
    }
    .kpi-head{ font-size:13px; text-transform:uppercase; letter-spacing:.6px; color:var(--ink-soft); margin:0 0 10px; }
    .kpi-val{  font-size:40px; font-weight:900; line-height:1.05; color:var(--ink-strong); margin:0; }
    .kpi-card::after{
      content:"↗";
      position:absolute; top:14px; right:14px;
      width:32px; height:32px; border-radius:999px;
      display:grid; place-items:center;
      font-weight:700; font-size:16px;
      color:#0f172a; background:#fff; border:1px solid var(--ring);
      box-shadow: 0 6px 14px rgba(17,23,39,.08);
      transition: all .35s ease;
    }
    .kpi-card:hover{
      background: var(--grad-purple);
      border-color: transparent;
      transform: translateY(-2px);
      box-shadow: 0 18px 40px rgba(78,0,150,.25);
    }
    .kpi-card:hover .kpi-head,
    .kpi-card:hover .kpi-val{ color:#fff; }
    .kpi-card:hover::after{
      color:#fff; background: rgba(255,255,255,.12); border-color:transparent;
    }

    /* ===== Responsive ===== */
    @media(max-width:900px){
      .col-7,.col-5{grid-column:span 12}
      .kpi-card{ grid-column: span 6; }
      .kpi-val{font-size:34px}
    }
    @media(max-width:640px){
      .container{padding:20px}
      .kpi-card{ grid-column: span 12; }
      .kpi-val{font-size:30px}
    }
  </style>
</head>
<body>

  <!-- ===== Portada ===== -->
  <section id="screen-cover" class="screen active">
    <div class="hero-landing">
      <div class="watermark-bg">SOLERA</div>
      <div class="landing-wrap">
        <h1 class="landing-title">
          SOLERA<br>
          DASHBOARD KPI’S
        </h1>

        <div class="landing-visual">
          <!-- Ajusta la ruta si tu imagen está en otra carpeta -->
          <img src="portadasolera.png" alt="Portada Solera">
        </div>

        <div class="landing-cta">
          <button class="btn-dark" onclick="go('login')">Ingresar</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Login ===== -->
  <section id="screen-login" class="screen">
    <div class="wrap">
      <div class="card">
        <h3 style="margin:0 0 10px 0">Acceso al dashboard</h3>
        <p style="color:#666;margin:0 0 16px 0">Introduce tus credenciales para continuar.</p>
        <form onsubmit="return doLogin(event)">
          <label for="user">Usuario</label>
          <input id="user" type="text" placeholder="usuario" required/>
          <label for="pass">Contraseña</label>
          <input id="pass" type="password" placeholder="contraseña" required/>
          <div style="display:flex;gap:10px;margin-top:6px">
            <button class="btn" type="submit">Entrar</button>
            <button class="btn secondary" type="button" onclick="go('cover')">Volver</button>
          </div>
          <div id="err" class="error">Usuario o contraseña incorrectos.</div>
        </form>
        <div style="font-size:12px;color:#999;margin-top:10px">Demo: usuario <b>admin</b> / contraseña <b>1234</b>.</div>
      </div>
    </div>
  </section>

  <!-- ===== Dashboard ===== -->
  <section id="screen-dashboard" class="screen">
    <nav class="nav">
      <div class="brand" style="font-weight:700">SOLERA — Dashboard</div>
      <a href="#" onclick="logout();return false;">Cerrar sesión</a>
    </nav>

    <div class="container">
      <!-- Fila 1: KPIs con hover morado -->
      <div class="kpi-row">
        <div class="kpi-card">
          <p class="kpi-head">Estado con mayor No. de Valuaciones</p>
          <p class="kpi-val" id="kpi_estado_val">—</p>
        </div>
        <div class="kpi-card">
          <p class="kpi-head">Fabricante con mayor No. de Valuaciones</p>
          <p class="kpi-val" id="kpi_fab_val">—</p>
        </div>
        <div class="kpi-card">
          <p class="kpi-head">Estado con mayor Piezas Sustituidas</p>
          <p class="kpi-val" id="kpi_estado_pzs">—</p>
        </div>
        <div class="kpi-card">
          <p class="kpi-head">Fabricante con mayor Piezas Sustituidas</p>
          <p class="kpi-val" id="kpi_fab_pzs">—</p>
        </div>
      </div>

      <!-- Fila 2: Mapa + panel derecho -->
      <div class="grid-12" style="margin-top:16px">
        <div class="card2 col-7">
          <div class="card-pad"><div class="title">Detalle por estado (mapa)</div></div>
          <div class="viz" style="height:420px;padding:0;overflow:hidden">
            <iframe id="mx_iframe" src="mx_map.html"
              style="width:100%;height:100%;border:0;border-radius:16px" loading="lazy" referrerpolicy="no-referrer"></iframe>
          </div>
        </div>
        <div class="col-5" style="display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:16px">
          <div class="card2 card-pad col-12">
            <div class="title" style="margin-bottom:8px">Top Fabricantes por Piezas Sustituidas</div>
            <div class="muted">(espacio para tu lista/gráfica)</div>
          </div>
          <div class="card2 card-pad col-12">
            <div class="title" style="margin-bottom:8px">Modelos con más Valuaciones</div>
            <div class="muted">placeholder</div>
          </div>
          <div class="card2 card-pad col-12">
            <div class="title" style="margin-bottom:8px">NPS y feedback</div>
            <div class="muted">placeholder</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Scripts ===== -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // ------ SPA nav ------
    function go(where){
      const ids=['cover','login','dashboard'];
      ids.forEach(id=>document.getElementById('screen-'+id).classList.remove('active'));
      document.getElementById('screen-'+where).classList.add('active');
      window.scrollTo({top:0,behavior:'instant'});
      if(where==='dashboard'){ startAuto(); } else { stopAuto(); }
    }
    function doLogin(e){
      e.preventDefault();
      const u=document.getElementById('user').value.trim();
      const p=document.getElementById('pass').value.trim();
      const err=document.getElementById('err');
      if(u==='admin' && p==='1234'){ go('dashboard'); }
      else{ err.style.display='block'; setTimeout(()=>err.style.display='none',3000); }
      return false;
    }
    function logout(){ go('cover'); document.getElementById('user').value=''; document.getElementById('pass').value=''; }

    // ------ KPIs desde Google Sheets ------
    const SHEET_URL_HTML="https://docs.google.com/spreadsheets/d/e/2PACX-1vTY8caVTcwnisoepB9R_rBQ2DAKlmxpTfA3WYqgaZQF2I2J2abE68cyJWvyd9Byu8QOP-N0nwOHWQ2K/pubhtml";
    const SHEET_URL_CSV =SHEET_URL_HTML.replace("/pubhtml","/pub?output=csv");

    function parseNumLocale(x){
      if(x==null) return null;
      let s=String(x).trim().replace(/\s+/g,'').replace(/\$/g,'');
      if(s.includes(',') && s.includes('.')){
        if(s.lastIndexOf(',')>s.lastIndexOf('.')){ s=s.replace(/\./g,'').replace(',', '.'); }
        else{ s=s.replace(/,/g,''); }
      }else if(s.includes(',') && !s.includes('.')){ s=s.replace(/\./g,'').replace(',', '.'); }
      const v=Number(s); return Number.isFinite(v)?v:null;
    }
    function loadKPIs(){
      return new Promise((resolve,reject)=>{
        Papa.parse(SHEET_URL_CSV,{
          download:true, header:true, dynamicTyping:false, skipEmptyLines:true,
          complete:(res)=>{
            try{
              const rows=res.data.filter(r=>r && r.Estado && r.Fabricante);
              rows.forEach(r=>{
                r["No Valuaciones"]=parseNumLocale(r["No Valuaciones"]);
                r["Piezas Sustituidas"]=parseNumLocale(r["Piezas Sustituidas"]);
                r["Costo Medio Pieza"]=parseNumLocale(r["Costo Medio Pieza"]);
              });
              const aggE=new Map(), aggF=new Map();
              for(const r of rows){
                const e=String(r.Estado||'').trim();
                const f=String(r.Fabricante||'').trim();
                const nv=r["No Valuaciones"]||0, pz=r["Piezas Sustituidas"]||0;
                if(!aggE.has(e)) aggE.set(e,{Estado:e,No_Valuaciones:0,Piezas_Sustituidas:0});
                if(!aggF.has(f)) aggF.set(f,{Fabricante:f,No_Valuaciones:0,Piezas_Sustituidas:0});
                aggE.get(e).No_Valuaciones+=nv; aggE.get(e).Piezas_Sustituidas+=pz;
                aggF.get(f).No_Valuaciones+=nv; aggF.get(f).Piezas_Sustituidas+=pz;
              }
              const est=[...aggE.values()], fab=[...aggF.values()];
              const top=(a,k)=>a.reduce((x,y)=>y[k]>(x?.[k]??-Infinity)?y:x,null);
              const topEV=top(est,'No_Valuaciones'),
                    topEP=top(est,'Piezas_Sustituidas'),
                    topFV=top(fab,'No_Valuaciones'),
                    topFP=top(fab,'Piezas_Sustituidas');
              const fmt=x=>x==null?'—':Number(Math.round(x)).toLocaleString('es-MX');
              document.getElementById('kpi_estado_val').textContent = topEV ? `${topEV.Estado} · ${fmt(topEV.No_Valuaciones)}` : '—';
              document.getElementById('kpi_fab_val').textContent    = topFV ? `${topFV.Fabricante} · ${fmt(topFV.No_Valuaciones)}` : '—';
              document.getElementById('kpi_estado_pzs').textContent = topEP ? `${topEP.Estado} · ${fmt(topEP.Piezas_Sustituidas)}` : '—';
              document.getElementById('kpi_fab_pzs').textContent    = topFP ? `${topFP.Fabricante} · ${fmt(topFP.Piezas_Sustituidas)}` : '—';
              resolve();
            }catch(e){ reject(e); }
          },
          error: reject
        });
      });
    }

    // ------ Auto-refresh KPIs + mapa ------
    const MX_IFRAME_URL="mx_map.html";
    let kpiTimer=null, mapTimer=null;
    function refreshMxMap(){
      const f=document.getElementById('mx_iframe');
      if(!f) return;
      f.src=MX_IFRAME_URL+"?t="+Date.now();
    }
    function startAuto(){
      stopAuto();
      loadKPIs().catch(console.error);
      kpiTimer=setInterval(()=>loadKPIs().catch(console.error), 120*1000); // 2 min
      mapTimer=setInterval(refreshMxMap, 180*1000); // 3 min
    }
    function stopAuto(){
      if(kpiTimer) clearInterval(kpiTimer), kpiTimer=null;
      if(mapTimer) clearInterval(mapTimer), mapTimer=null;
    }
    document.addEventListener('DOMContentLoaded',()=>{
      if(document.getElementById('screen-dashboard').classList.contains('active')) startAuto();
    });

    // Navegación inicial por si entras directo
    function go(where){
      const ids=['cover','login','dashboard'];
      ids.forEach(id=>document.getElementById('screen-'+id).classList.remove('active'));
      document.getElementById('screen-'+where).classList.add('active');
      window.scrollTo({top:0,behavior:'instant'});
      if(where==='dashboard'){ startAuto(); } else { stopAuto(); }
    }
    function doLogin(e){
      e.preventDefault();
      const u=document.getElementById('user').value.trim();
      const p=document.getElementById('pass').value.trim();
      const err=document.getElementById('err');
      if(u==='admin' && p==='1234'){ go('dashboard'); }
      else{ err.style.display='block'; setTimeout(()=>err.style.display='none',3000); }
      return false;
    }
    function logout(){ go('cover'); document.getElementById('user').value=''; document.getElementById('pass').value=''; }
  </script>
</body>
</html>
