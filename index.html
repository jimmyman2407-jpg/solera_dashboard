<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Solera — Dashboard</title>
  <style>
    :root{
      --bg:#f7f9fc; --paper:#fff; --ink:#0f172a; --muted:#6b7280;
      --border:#e8ecf3; --shadow:0 20px 50px rgba(10,20,30,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}

    /* ===== SPA screens ===== */
    .screen{display:none;min-height:100vh}
    .screen.active{display:block}

    /* ===== Top nav (solo dashboard) ===== */
    .nav{position:sticky;top:0;z-index:10;background:var(--paper);border-bottom:1px solid var(--border);
      display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 20px;
      box-shadow:0 6px 20px rgba(17,17,26,.05)}
    .nav a{color:var(--ink);text-decoration:none;border:1px solid var(--border);border-radius:10px;padding:8px 12px;background:linear-gradient(#fff,#f8f9ff)}

    /* ===== Layout helpers ===== */
    .container{max-width:1280px;margin:0 auto;padding:32px}
    .grid-12{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:16px}
    .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-5{grid-column:span 5}
    .col-6{grid-column:span 6}.col-7{grid-column:span 7}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    .card2{background:var(--paper);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .card-pad{padding:18px}
    .viz{min-height:280px;border:1px solid var(--border);border-radius:16px;background:#fff;box-shadow:inset 0 1px 0 rgba(255,255,255,.6),0 6px 20px rgba(17,17,26,.04)}
    .btn{background:#111;color:#fff;padding:12px 20px;border-radius:10px;border:none;cursor:pointer;font-weight:700;letter-spacing:.3px}
    .btn.secondary{background:transparent;color:var(--ink);border:1px solid var(--border)}
    .title{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.6px}
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi .value{font-size:36px;font-weight:800}

    /* ===== Hero (portada v1 simple, mejor distribuida) ===== */
    .hero{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px;background:
      radial-gradient(110% 80% at 10% 10%, #eef2f7 0%, rgba(255,255,255,.8) 45%, #ffffff 100%),
      linear-gradient(180deg,#ffffff 0%, #f4f6fb 100%)}
    .hero-grid{width:100%;max-width:1200px;display:grid;grid-template-columns:1.05fr .95fr;gap:28px;align-items:center}
    .hero-text{border-radius:18px}
    .hero-text .eyebrow{font-size:12px;letter-spacing:.14em;color:#4b5563;margin:0 0 6px}
    .hero-text h1{font-size:64px;line-height:.95;margin:0}
    .hero-text h2{font-size:40px;margin:4px 0 8px 0}
    .hero-text .sublead{color:#475569;margin:2px 0 12px 0;max-width:60ch}
    .hero-visual{height:520px;border:1px solid var(--border);border-radius:22px;overflow:hidden;box-shadow:0 30px 70px rgba(12,20,33,.10)}
    .hero-visual img{width:100%;height:100%;object-fit:cover;display:block}

    /* ===== Login ===== */
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:420px;background:#fff;border:1px solid var(--border);border-radius:14px;padding:26px;box-shadow:var(--shadow)}
    label{display:block;font-size:13px;color:#333;margin-bottom:6px}
    input[type=text],input[type=password]{width:100%;padding:12px 14px;border:1px solid #e6e9ee;border-radius:8px;margin-bottom:12px}
    .error{color:#b00020;font-size:13px;display:none;margin-top:6px}

    /* ===== Responsive ===== */
    @media(max-width:1100px){
      .hero-grid{grid-template-columns:1fr}
      .hero-visual{order:1;height:400px}
      .hero-text{order:2}
      .hero-text h1{font-size:56px}
    }
    @media(max-width:900px){
      .col-7,.col-5{grid-column:span 12}
      .kpi .value{font-size:32px}
    }
    @media(max-width:640px){
      .container{padding:20px}
      .hero-visual{height:300px}
      .hero-text h1{font-size:44px}
      .hero-text h2{font-size:30px}
      .kpi .value{font-size:28px}
    }
  </style>
</head>
<body>

  <!-- ===== Cover ===== -->
  <section id="screen-cover" class="screen active">
    <div class="hero">
      <div class="hero-grid">
        <div class="hero-text card2 card-pad">
          <p class="eyebrow">REPORTE EJECUTIVO</p>
          <h1>Dashboard</h1>
          <h2>KPI's</h2>
          <p class="sublead">Visión clara de performance con datos al día. Entra para explorar el detalle por estado, fabricante y modelo.</p>
          <div class="cta" style="display:flex;gap:10px">
            <button class="btn" onclick="go('login')">Ingresar</button>
            <button class="btn secondary" onclick="go('dashboard')">Ver demo</button>
          </div>
        </div>
        <div class="hero-visual">
          <!-- Tu imagen ya en GitHub: portadasolera.png -->
          <img src="portadasolera.png" alt="Portada Solera"/>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Login ===== -->
  <section id="screen-login" class="screen">
    <div class="wrap">
      <div class="card">
        <h3 style="margin:0 0 10px 0">Acceso al dashboard</h3>
        <p style="color:#666;margin:0 0 16px 0">Introduce tus credenciales para continuar.</p>
        <form onsubmit="return doLogin(event)">
          <label for="user">Usuario</label>
          <input id="user" type="text" placeholder="usuario" required/>
          <label for="pass">Contraseña</label>
          <input id="pass" type="password" placeholder="contraseña" required/>
          <div style="display:flex;gap:10px;margin-top:6px">
            <button class="btn" type="submit">Entrar</button>
            <button class="btn secondary" type="button" onclick="go('cover')">Volver</button>
          </div>
          <div id="err" class="error">Usuario o contraseña incorrectos.</div>
        </form>
        <div style="font-size:12px;color:#999;margin-top:10px">Demo: usuario <b>admin</b> / contraseña <b>1234</b>.</div>
      </div>
    </div>
  </section>

  <!-- ===== Dashboard ===== -->
  <section id="screen-dashboard" class="screen">
    <nav class="nav">
      <div class="brand" style="font-weight:700">SOLERA — Dashboard</div>
      <a href="#" onclick="logout();return false;">Cerrar sesión</a>
    </nav>

    <div class="container">
      <!-- Nivel 1: KPIs -->
      <div class="grid-12">
        <div class="card2 card-pad col-3 kpi">
          <div class="title">Estado con mayor No. de Valuaciones</div>
          <div class="value" id="kpi_estado_val">—</div>
        </div>
        <div class="card2 card-pad col-3 kpi">
          <div class="title">Fabricante con mayor No. de Valuaciones</div>
          <div class="value" id="kpi_fab_val">—</div>
        </div>
        <div class="card2 card-pad col-3 kpi">
          <div class="title">Estado con mayor Piezas Sustituidas</div>
          <div class="value" id="kpi_estado_pzs">—</div>
        </div>
        <div class="card2 card-pad col-3 kpi">
          <div class="title">Fabricante con mayor Piezas Sustituidas</div>
          <div class="value" id="kpi_fab_pzs">—</div>
        </div>
      </div>

      <!-- Nivel 2: Mapa izquierda + panel derecho -->
      <div class="grid-12" style="margin-top:16px">
        <!-- IZQ: mapa -->
        <div class="card2 col-7">
          <div class="card-pad"><div class="title">Detalle por estado (mapa)</div></div>
          <div class="viz" id="viz-mapa" style="height:420px;padding:0;overflow:hidden">
            <iframe id="mx_iframe" src="mx_map.html"
              style="width:100%;height:100%;border:0;border-radius:16px" loading="lazy" referrerpolicy="no-referrer"></iframe>
          </div>
        </div>
        <!-- DER: placeholders para listas / gráficas adicionales -->
        <div class="col-5" style="display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:16px">
          <div class="card2 card-pad col-12">
            <div class="title" style="margin-bottom:8px">Top Fabricantes por Piezas Sustituidas</div>
            <div class="muted">(Integra aquí tu lista/gráfica; queda espacio preparado)</div>
          </div>
          <div class="card2 card-pad col-12">
            <div class="title" style="margin-bottom:8px">Modelos con más Valuaciones</div>
            <div class="muted">Placeholder</div>
          </div>
          <div class="card2 card-pad col-12">
            <div class="title" style="margin-bottom:8px">NPS y feedback</div>
            <div class="muted">Placeholder</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Scripts ===== -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // -------- SPA nav ----------
    function go(where){
      const ids=['cover','login','dashboard'];
      ids.forEach(id=>document.getElementById('screen-'+id).classList.remove('active'));
      document.getElementById('screen-'+where).classList.add('active');
      window.scrollTo({top:0,behavior:'instant'});
      if(where==='dashboard'){ startAuto(); } else { stopAuto(); }
    }
    function doLogin(e){
      e.preventDefault();
      const u = document.getElementById('user').value.trim();
      const p = document.getElementById('pass').value.trim();
      const err = document.getElementById('err');
      if(u==='admin' && p==='1234'){ go('dashboard'); }
      else { err.style.display='block'; setTimeout(()=> err.style.display='none', 3000); }
      return false;
    }
    function logout(){ go('cover'); document.getElementById('user').value=''; document.getElementById('pass').value=''; }

    // -------- KPIs (auto actualizados desde Google Sheets publicado) ----------
    const SHEET_URL_HTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTY8caVTcwnisoepB9R_rBQ2DAKlmxpTfA3WYqgaZQF2I2J2abE68cyJWvyd9Byu8QOP-N0nwOHWQ2K/pubhtml";
    const SHEET_URL_CSV  = SHEET_URL_HTML.replace("/pubhtml","/pub?output=csv");

    function parseNumLocale(x){
      if(x==null) return null;
      let s = String(x).trim().replace(/\s+/g,'').replace(/\$/g,'');
      if(s.includes(',') && s.includes('.')){
        if(s.lastIndexOf(',') > s.lastIndexOf('.')){ s = s.replace(/\./g,'').replace(',', '.'); }
        else { s = s.replace(/,/g,''); }
      } else if(s.includes(',') && !s.includes('.')){
        s = s.replace(/\./g,'').replace(',', '.');
      }
      const v = Number(s); return Number.isFinite(v) ? v : null;
    }

    function loadKPIs(){
      return new Promise((resolve,reject)=>{
        Papa.parse(SHEET_URL_CSV,{
          download:true, header:true, dynamicTyping:false, skipEmptyLines:true,
          complete:(res)=>{
            try{
              const rows = res.data.filter(r=>r && r.Estado && r.Fabricante);
              rows.forEach(r=>{
                r["No Valuaciones"]     = parseNumLocale(r["No Valuaciones"]);
                r["Piezas Sustituidas"] = parseNumLocale(r["Piezas Sustituidas"]);
                r["Costo Medio Pieza"]  = parseNumLocale(r["Costo Medio Pieza"]);
              });

              const aggE = new Map(), aggF = new Map();
              for(const r of rows){
                const e = String(r.Estado||'').trim();
                const f = String(r.Fabricante||'').trim();
                const nv = r["No Valuaciones"]||0, pz = r["Piezas Sustituidas"]||0;
                if(!aggE.has(e)) aggE.set(e,{Estado:e, No_Valuaciones:0, Piezas_Sustituidas:0});
                if(!aggF.has(f)) aggF.set(f,{Fabricante:f, No_Valuaciones:0, Piezas_Sustituidas:0});
                aggE.get(e).No_Valuaciones += nv; aggE.get(e).Piezas_Sustituidas += pz;
                aggF.get(f).No_Valuaciones += nv; aggF.get(f).Piezas_Sustituidas += pz;
              }
              const est = Array.from(aggE.values());
              const fab = Array.from(aggF.values());
              const top = (arr,key)=>arr.reduce((a,b)=>b[key]>(a?.[key]??-Infinity)?b:a,null);
              const topEV = top(est,'No_Valuaciones');
              const topEP = top(est,'Piezas_Sustituidas');
              const topFV = top(fab,'No_Valuaciones');
              const topFP = top(fab,'Piezas_Sustituidas');
              const fmt = x => x==null ? '—' : Number(Math.round(x)).toLocaleString('es-MX');

              document.getElementById('kpi_estado_val').textContent = topEV ? `${topEV.Estado} · ${fmt(topEV.No_Valuaciones)}` : '—';
              document.getElementById('kpi_fab_val').textContent    = topFV ? `${topFV.Fabricante} · ${fmt(topFV.No_Valuaciones)}` : '—';
              document.getElementById('kpi_estado_pzs').textContent = topEP ? `${topEP.Estado} · ${fmt(topEP.Piezas_Sustituidas)}` : '—';
              document.getElementById('kpi_fab_pzs').textContent    = topFP ? `${topFP.Fabricante} · ${fmt(topFP.Piezas_Sustituidas)}` : '—';
              resolve();
            }catch(e){ reject(e); }
          },
          error: reject
        });
      });
    }

    // -------- Auto-refresh KPIs + mapa (iframe) ----------
    const MX_IFRAME_URL = "mx_map.html";
    let kpiTimer=null, mapTimer=null;

    function refreshMxMap(){
      const f = document.getElementById('mx_iframe');
      if(!f) return;
      f.src = MX_IFRAME_URL + "?t=" + Date.now(); // rompe caché
    }
    function startAuto(){
      stopAuto();
      loadKPIs().catch(console.error);
      kpiTimer = setInterval(()=>loadKPIs().catch(console.error), 120*1000); // 2 min
      mapTimer = setInterval(refreshMxMap, 180*1000); // 3 min
    }
    function stopAuto(){
      if(kpiTimer) clearInterval(kpiTimer), kpiTimer=null;
      if(mapTimer) clearInterval(mapTimer), mapTimer=null;
    }

    // Si alguien abre directo el dashboard:
    document.addEventListener('DOMContentLoaded',()=>{
      if(document.getElementById('screen-dashboard').classList.contains('active')) startAuto();
    });
  </script>
</body>
</html>
