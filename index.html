
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Solera — Portada + Login + Dashboard</title>

<!-- Leaflet (mapa) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Plotly (barras) -->
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

<!-- PapaParse (leer CSV de Google Sheets) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- Fuente -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet"/>

<style>
  /* ============ PALETA Y TOKENS ============ */
  :root{
    --bg:#f7f9fc; --paper:#ffffff; --border:#e8ecf3;
    --ink:#0f172a; --muted:#6b7280;
    --solera-dark:#120a35; --solera-ink:#eef0fa;
    --accent:#9b8cff;
    --grad: linear-gradient(90deg, rgb(60,0,130), rgb(100,20,200), rgb(156,54,255));
    --shadow-lg: 0 24px 60px rgba(20,12,60,.18);
    --shadow-md: 0 16px 40px rgba(20,12,60,.12);
    --shadow-sm: 0 10px 28px rgba(20,12,60,.10);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}

  /* ============ SPA SCREENS ============ */
  .screen{display:none;min-height:100vh}
  .screen.active{display:block}

  /* ============ PORTADA (estructura limpia) ============ */
  .hero{position:relative;min-height:100vh;display:flex;align-items:center;justify-content:center;background:#fff;padding:40px 24px;overflow:hidden}
  .watermark{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;user-select:none;z-index:0;
             font-weight:900;letter-spacing:8px;color:#e5e7eb;opacity:.75;line-height:1;font-size:240px;white-space:nowrap;transform:translateY(6%)}
  @media (max-width:1200px){ .watermark{font-size:200px} }
  @media (max-width:900px){  .watermark{font-size:160px; transform:translateY(8%)} }
  @media (max-width:600px){  .watermark{font-size:120px; transform:translateY(10%)} }
  .hero-wrap{position:relative;z-index:1;max-width:980px;width:100%;display:flex;flex-direction:column;align-items:center;text-align:center}
  .hero h1{font-weight:900;letter-spacing:1px;line-height:1;margin:0 0 18px;color:#2b2f33;text-transform:uppercase;font-size:64px;text-shadow:0 2px 0 rgba(255,255,255,.6)}
  @media (max-width:900px){ .hero h1{font-size:48px} }
  @media (max-width:600px){ .hero h1{font-size:38px} }
  .hero-visual{margin:18px 0 20px;max-width:520px;width:100%;filter:drop-shadow(0 18px 40px rgba(0,0,0,.12))}
  .hero-visual img{width:100%;height:auto;display:block;object-fit:contain;border-radius:12px}
  .cta{
    background:var(--grad);color:#fff;border:0;padding:12px 18px;border-radius:10px;cursor:pointer;
    font-weight:800;letter-spacing:.3px;box-shadow:var(--shadow-md);transition:transform .15s ease, box-shadow .15s ease
  }
  .cta:hover{transform:translateY(-1px)}

  /* ============ LOGIN (idéntico estilo organizado) ============ */
  .login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;background:var(--bg)}
  .login-card{width:100%;max-width:420px;background:#fff;border:1px solid var(--border);border-radius:14px;padding:26px;box-shadow:var(--shadow-md)}
  .login-card h3{margin:0 0 10px 0;font-weight:800;color:#111827}
  .login-card p{color:#6b7280;margin:0 0 16px 0}
  label{display:block;font-size:13px;color:#374151;margin-bottom:6px}
  input[type="text"], input[type="password"]{
    width:100%;padding:12px 14px;border:1px solid #e6e9ee;border-radius:8px;background:#fff;color:#111827;outline:none;
    transition:border-color .2s, box-shadow .2s;margin-bottom:12px
  }
  input[type="text"]:focus, input[type="password"]:focus{border-color:#cfd7ef;box-shadow:0 0 0 4px rgba(99,102,241,.12)}
  .btn{background:#111827;color:#fff;padding:12px 20px;border-radius:10px;border:none;cursor:pointer;font-weight:700;letter-spacing:.3px;transition:transform .15s ease, box-shadow .15s ease}
  .btn:hover{transform:translateY(-1px)}
  .btn.secondary{background:transparent;color:#111827;border:1px solid var(--border)}
  .error{color:#b00020;font-size:13px;display:none;margin-top:6px}

  /* ============ NAV DASHBOARD ============ */
  .nav{
    position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);
    display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 20px;box-shadow:0 6px 20px rgba(17,17,26,.05)
  }
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.4px}
  .brand-mark{width:28px;height:28px;border-radius:7px;background:var(--grad)}
  .nav a{color:var(--ink);text-decoration:none;border:1px solid var(--border);border-radius:10px;padding:8px 12px;background:linear-gradient(#fff,#f8f9ff)}
  .nav a:hover{border-color:#dfe4f3}

  /* ============ LAYOUT DASHBOARD ============ */
  .container{max-width:1280px;margin:0 auto;padding:24px}
  .grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:16px}
  .col-12{grid-column:span 12}.col-7{grid-column:span 7}.col-5{grid-column:span 5}
  .card{background:var(--paper);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow-sm)}
  .head{padding:14px 16px;border-bottom:1px solid var(--border);font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.6px}
  .body{padding:12px}
  .viz{height:240px}

  /* ============ MAPA + TOOLBAR ============ */
  #map{height:520px;border-radius:14px;overflow:hidden}
  .toolbar{display:flex;gap:8px;align-items:center;margin:10px 0 0 0;flex-wrap:wrap}
  .btn-outline{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn-primary{background:var(--grad);color:#fff;border:0}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#f2f4ff;border:1px solid #e3e7ff;color:#2b2f4b;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600}

  /* ============ KPIs (manteniendo jerarquía de texto) ============ */
  .kpis{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:16px}
  .kpi{grid-column:span 3;position:relative;border-radius:18px;background:#fff;border:1px solid var(--border);
       box-shadow:0 10px 24px rgba(17,23,39,.06);padding:22px 22px 20px;transition:all .35s ease;overflow:hidden}
  .kpi .sub{font-size:13px;text-transform:uppercase;letter-spacing:.6px;color:#5b667a;margin:0 0 12px}
  .kpi .name{font-size:42px;font-weight:900;line-height:1.05;color:#0b1324;margin:0 0 8px}
  .kpi .num{font-size:34px;font-weight:800;line-height:1.05;color:#101827;margin:0;letter-spacing:.3px}
  .kpi::after{content:"↗";position:absolute;top:14px;right:14px;width:32px;height:32px;border-radius:999px;display:grid;place-items:center;font-weight:700;font-size:16px;color:#0f172a;background:#fff;border:1px solid var(--border);box-shadow:0 6px 14px rgba(17,23,39,.08);transition:all .35s ease}
  .kpi:hover{background:var(--grad);border-color:transparent;transform:translateY(-2px);box-shadow:0 18px 40px rgba(78,0,150,.25)}
  .kpi:hover .sub,.kpi:hover .name,.kpi:hover .num{color:#fff}
  .kpi:hover::after{color:#fff;background:rgba(255,255,255,.12);border-color:transparent}

  @media(max-width:900px){ .col-7,.col-5{grid-column:span 12} .kpi{grid-column:span 6} .kpi .name{font-size:36px} .kpi .num{font-size:30px} }
  @media(max-width:640px){ .kpi{grid-column:span 12} .container{padding:16px} .kpi .name{font-size:32px} .kpi .num{font-size:28px} }
</style>
</head>
<body>

<!-- ===================== PORTADA ===================== -->
<section id="screen-cover" class="screen active">
  <div class="hero">
    <div class="watermark">SOLERA</div>
    <div class="hero-wrap">
      <h1>SOLERA<br/>DASHBOARD KPI’S</h1>
      <div class="hero-visual">
        <!-- Asegúrate de tener este archivo en tu repo -->
        <img src="portadasolera.png" alt="Portada Solera">
      </div>
      <button class="cta" onclick="go('login')">Ingresar</button>
    </div>
  </div>
</section>

<!-- ===================== LOGIN ===================== -->
<section id="screen-login" class="screen">
  <div class="login-wrap">
    <div class="login-card">
      <h3>Acceso al dashboard</h3>
      <p>Introduce tus credenciales para continuar.</p>
      <form onsubmit="return doLogin(event)">
        <label for="user">Usuario</label>
        <input id="user" type="text" placeholder="usuario" required/>
        <label for="pass">Contraseña</label>
        <input id="pass" type="password" placeholder="contraseña" required/>
        <div style="display:flex;gap:10px;margin-top:6px">
          <button class="btn" type="submit">Entrar</button>
          <button class="btn secondary" type="button" onclick="go('cover')">Volver</button>
        </div>
        <div id="err" class="error">Usuario o contraseña incorrectos.</div>
      </form>
      <div style="font-size:12px;color:#999;margin-top:10px">Demo: usuario <b>admin</b> / contraseña <b>1234</b>.</div>
    </div>
  </div>
</section>

<!-- ===================== DASHBOARD ===================== -->
<section id="screen-dashboard" class="screen">
  <nav class="nav">
    <div class="brand"><span class="brand-mark"></span> SOLERA — Dashboard</div>
    <a href="#" onclick="logout();return false;">Cerrar sesión</a>
  </nav>

  <div class="container">
    <!-- KPIs (no tocar comportamiento, solo jerarquía visual ya aplicada) -->
    <div class="kpis">
      <div class="kpi">
        <p class="sub">Estado con mayor No. de Valuaciones</p>
        <p class="name" id="kpi_estado_val_name">—</p>
        <p class="num"  id="kpi_estado_val_num">—</p>
      </div>
      <div class="kpi">
        <p class="sub">Fabricante con mayor No. de Valuaciones</p>
        <p class="name" id="kpi_fab_val_name">—</p>
        <p class="num"  id="kpi_fab_val_num">—</p>
      </div>
      <div class="kpi">
        <p class="sub">Estado con mayor Piezas Sustituidas</p>
        <p class="name" id="kpi_estado_pzs_name">—</p>
        <p class="num"  id="kpi_estado_pzs_num">—</p>
      </div>
      <div class="kpi">
        <p class="sub">Fabricante con mayor Piezas Sustituidas</p>
        <p class="name" id="kpi_fab_pzs_name">—</p>
        <p class="num"  id="kpi_fab_pzs_num">—</p>
      </div>
    </div>

    <!-- Mapa a la izquierda; columnas de barras a la derecha -->
    <div class="grid" style="margin-top:16px">
      <div class="card col-7">
        <div class="head">Detalle por estado (mapa)</div>
        <div class="body">
          <div id="map"></div>
          <div class="toolbar">
            <button class="btn-outline btn-primary" onclick="clearState()">Quitar filtro</button>
            <span class="pill">Filtro actual: <b id="state_badge">Todos</b></span>
          </div>
        </div>
      </div>

      <div class="col-5" style="display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:16px">
        <div class="card col-12">
          <div class="head">Top Fabricantes · No de Valuaciones</div>
          <div class="body"><div id="plot_val" class="viz"></div></div>
        </div>
        <div class="card col-12">
          <div class="head">Top Fabricantes · Piezas Sustituidas</div>
          <div class="body"><div id="plot_pzs" class="viz"></div></div>
        </div>
        <div class="card col-12">
          <div class="head">Top Fabricantes · Costo medio por pieza</div>
          <div class="body"><div id="plot_costo" class="viz"></div></div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
/* ===================== NAV SPA ===================== */
function go(where){
  ['cover','login','dashboard'].forEach(id=>document.getElementById('screen-'+id).classList.remove('active'));
  document.getElementById('screen-'+where).classList.add('active');
  if(where==='dashboard'){ startAuto(); } else { stopAuto(); }
  window.scrollTo({top:0,behavior:'instant'});
}
function doLogin(e){
  e.preventDefault();
  const u=document.getElementById('user').value.trim();
  const p=document.getElementById('pass').value.trim();
  const err=document.getElementById('err');
  if(u==='admin' && p==='1234'){ go('dashboard'); }
  else{ err.style.display='block'; setTimeout(()=>err.style.display='none',3000); }
  return false;
}
function logout(){ go('cover'); document.getElementById('user').value=''; document.getElementById('pass').value=''; }

/* ===================== DATOS ===================== */
const SHEET_URL_HTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTY8caVTcwnisoepB9R_rBQ2DAKlmxpTfA3WYqgaZQF2I2J2abE68cyJWvyd9Byu8QOP-N0nwOHWQ2K/pubhtml";
const SHEET_URL_CSV  = SHEET_URL_HTML.replace("/pubhtml","/pub?output=csv");
const MX_GEOJSON     = "https://raw.githubusercontent.com/angelnmara/geojson/master/mexicoHigh.json";
const REFRESH_MS     = 120*1000; // auto-actualización cada 2 min

let rawRows=[], geo=null, map=null, layer=null, selectedState=null, timer=null;

const ALIAS = {
  "DISTRITO FEDERAL":"CIUDAD DE MEXICO","CDMX":"CIUDAD DE MEXICO","CIUDAD DE MEXICO":"CIUDAD DE MEXICO",
  "ESTADO DE MEXICO":"MEXICO","MEXICO":"MEXICO","COAHUILA DE ZARAGOZA":"COAHUILA",
  "QUERETARO ARTEAGA":"QUERETARO","QUERETARO DE ARTEAGA":"QUERETARO",
  "MICHOACAN DE OCAMPO":"MICHOACAN","VERACRUZ DE IGNACIO DE LA LLAVE":"VERACRUZ",
  "SAN LUIS POTOSI":"SAN LUIS POTOSI","NUEVO LEON":"NUEVO LEON","YUCATAN":"YUCATAN",
};
const PSEUDO = new Set(["NO DISPONIBLE","SIN CODIGO POSTAL","SIN CODIGO"]);

const norm = s => {
  s = String(s||"").trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").toUpperCase();
  return ALIAS[s] || s;
}
function parseNumLocale(x){
  if(x==null) return null;
  let s=String(x).trim().replace(/\s+/g,'').replace(/\$/g,'');
  if(s.includes(',') && s.includes('.')){
    if(s.lastIndexOf(',')>s.lastIndexOf('.')){ s=s.replace(/\./g,'').replace(',', '.'); }
    else{ s=s.replace(/,/g,''); }
  }else if(s.includes(',') && !s.includes('.')){ s=s.replace(/\./g,'').replace(',', '.'); }
  const v=Number(s); return Number.isFinite(v)?v:null;
}

/* ====== Leer Google Sheet (CSV publicado) ====== */
function loadSheet(){
  return new Promise((resolve,reject)=>{
    Papa.parse(SHEET_URL_CSV,{
      download:true, header:true, dynamicTyping:false, skipEmptyLines:true,
      complete:(res)=>{
        try{
          const rows=res.data.filter(r=>r && r.Estado && r.Fabricante).map(r=>({
            Estado: r.Estado, Fabricante: r.Fabricante,
            NoVal: parseNumLocale(r["No Valuaciones"]),
            Pzs:   parseNumLocale(r["Piezas Sustituidas"]),
            Costo: parseNumLocale(r["Costo Medio Pieza"]),
            STATE_KEY: norm(r.Estado)
          })).filter(r=>!PSEUDO.has(r.STATE_KEY));
          resolve(rows);
        }catch(e){ reject(e); }
      }, error: reject
    });
  });
}

function aggregate(rows, stateFilter=null){
  const R = stateFilter ? rows.filter(r=>r.STATE_KEY===stateFilter) : rows.slice();
  const est=new Map(), fab=new Map();
  for(const r of R){
    if(!est.has(r.STATE_KEY)) est.set(r.STATE_KEY,{Estado:r.STATE_KEY, NoVal:0, Pzs:0});
    if(!fab.has(r.Fabricante)) fab.set(r.Fabricante,{Fabricante:r.Fabricante, NoVal:0, Pzs:0, CostoSum:0, CostoN:0});
    est.get(r.STATE_KEY).NoVal += r.NoVal||0;
    est.get(r.STATE_KEY).Pzs   += r.Pzs||0;
    const F=fab.get(r.Fabricante);
    F.NoVal += r.NoVal||0; F.Pzs += r.Pzs||0;
    if(Number.isFinite(r.Costo)){ F.CostoSum += r.Costo; F.CostoN += 1; }
  }
  const estA=[...est.values()],
        fabA=[...fab.values()].map(f=>({...f, CostoProm: f.CostoN? f.CostoSum/f.CostoN : null}));
  return {estA, fabA};
}

/* ===================== KPIs ===================== */
function renderKPIs(rows){
  const {estA, fabA} = aggregate(rows, selectedState);
  const top = (arr,k) => arr.reduce((a,b)=> (b[k]>(a?.[k]??-Infinity)?b:a), null);
  const fmt = x => x==null ? '—' : Number(Math.round(x)).toLocaleString('es-MX');
  const topEV=top(estA,'NoVal'), topEP=top(estA,'Pzs'), topFV=top(fabA,'NoVal'), topFP=top(fabA,'Pzs');

  document.getElementById('kpi_estado_val_name').textContent = topEV?.Estado ?? '—';
  document.getElementById('kpi_estado_val_num').textContent  = fmt(topEV?.NoVal);
  document.getElementById('kpi_estado_pzs_name').textContent = topEP?.Estado ?? '—';
  document.getElementById('kpi_estado_pzs_num').textContent  = fmt(topEP?.Pzs);
  document.getElementById('kpi_fab_val_name').textContent    = topFV?.Fabricante ?? '—';
  document.getElementById('kpi_fab_val_num').textContent     = fmt(topFV?.NoVal);
  document.getElementById('kpi_fab_pzs_name').textContent    = topFP?.Fabricante ?? '—';
  document.getElementById('kpi_fab_pzs_num').textContent     = fmt(topFP?.Pzs);
}

/* ===================== BARRAS ===================== */
const PLOT_LAYOUT = {
  template: {
    layout: {
      paper_bgcolor:"#fff", plot_bgcolor:"#fff",
      font:{family:"Inter, system-ui, Segoe UI, Roboto, Arial", color:"#0f172a"},
      margin:{l:90,r:18,t:20,b:36},
      xaxis:{gridcolor:"#e8ecf3", zeroline:false}, yaxis:{gridcolor:"#e8ecf3", zeroline:false}
    }
  },
  showlegend:false
};
function bars(container, data, xKey, title){
  const top = data.slice().sort((a,b)=>b[xKey]-a[xKey]).slice(0,15);
  const y = top.map(d=>d.Fabricante);
  const x = top.map(d=>d[xKey]);
  const color = top.map((d,i)=> i===0 ? "#ffbf3c" : "#9b8cff");

  Plotly.newPlot(container,[{
    type:"bar", orientation:"h", x, y,
    marker:{color, line:{color:"rgba(0,0,0,.08)", width:1}},
    hovertemplate:"<b>%{y}</b><br>"+title+": %{x:,}<extra></extra>"
  }], PLOT_LAYOUT, {displayModeBar:false, responsive:true});
}
function renderBars(rows){
  const {fabA} = aggregate(rows, selectedState);
  bars('plot_val',   fabA, 'NoVal', 'No de Valuaciones');
  bars('plot_pzs',   fabA, 'Pzs',   'Piezas Sustituidas');
  const cost = fabA.filter(f=>Number.isFinite(f.CostoProm)).map(f=>({...f, CostoProm: Math.round(f.CostoProm)}));
  const top = cost.sort((a,b)=>b.CostoProm-a.CostoProm).slice(0,15);
  Plotly.newPlot('plot_costo',[{
    type:"bar", orientation:"h",
    x: top.map(d=>d.CostoProm), y: top.map(d=>d.Fabricante),
    marker:{color:"#58d1ff", line:{color:"rgba(0,0,0,.08)", width:1}},
    hovertemplate:"<b>%{y}</b><br>Costo medio: %{x:,}<extra></extra>"
  }], PLOT_LAYOUT, {displayModeBar:false, responsive:true});
}

/* ===================== MAPA ===================== */
function computeQuantiles(arr){
  const s = arr.slice().sort((a,b)=>a-b);
  const q = p => s.length? s[Math.min(s.length-1, Math.floor(p*(s.length-1)))] : 0;
  return [q(0.2),q(0.4),q(0.6),q(0.8)];
}
function claseByVal(v, qs){
  if(v<=qs[0]) return "#B0BEC5";
  if(v<=qs[1]) return "#26C6DA";
  if(v<=qs[2]) return "#2979FF";
  if(v<=qs[3]) return "#FF8F00";
  return "#00C853";
}
function buildMap(rows){
  if(!map){
    map = L.map('map',{zoomControl:true, attributionControl:false}).setView([23.5,-102],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);
  }
  if(layer){ layer.remove(); layer=null; }

  const {estA} = aggregate(rows);
  const dict = Object.fromEntries(estA.map(e=>[e.Estado, e]));
  geo.features.forEach(f=>{
    const k = norm(f.properties.name);
    f.properties.STATE_KEY = k;
    f.properties.NoVal = dict[k]?.NoVal || 0;
    f.properties.Pzs   = dict[k]?.Pzs   || 0;
  });

  const vals = geo.features.map(f=>f.properties.NoVal);
  const qs = computeQuantiles(vals);

  layer = L.geoJSON(geo,{
    style: f=>({fillColor:claseByVal(f.properties.NoVal,qs), color:"#555", weight:0.8, fillOpacity:.95}),
    onEachFeature: (f, lyr)=>{
      const k=f.properties.STATE_KEY;
      const html = `
        <div style="font-weight:800;margin-bottom:4px">${f.properties.name}</div>
        <div style="font-size:12px;color:#475569">
          No. Valuaciones: <b>${(dict[k]?.NoVal??0).toLocaleString('es-MX')}</b><br/>
          Piezas Sustituidas: <b>${(dict[k]?.Pzs??0).toLocaleString('es-MX')}</b>
        </div>`;
      lyr.bindTooltip(html,{sticky:true});
      lyr.on('click',()=>{
        selectedState = k;
        document.getElementById('state_badge').textContent = k;
        renderKPIs(rawRows);
        renderBars(rawRows);
      });
      lyr.on('mouseover',()=>lyr.setStyle({weight:2.2,color:"#111",fillOpacity:.98}));
      lyr.on('mouseout',()=>lyr.setStyle({weight:0.8,color:"#555",fillOpacity:.95}));
    }
  }).addTo(map);
}
function clearState(){
  selectedState = null;
  document.getElementById('state_badge').textContent = "Todos";
  renderKPIs(rawRows); renderBars(rawRows);
}

/* ===================== AUTO-REFRESH ===================== */
function refreshAll(){
  return loadSheet().then(rows=>{
    rawRows = rows;
    renderKPIs(rows);
    renderBars(rows);
    if(geo){ buildMap(rows); }
    else{
      fetch(MX_GEOJSON).then(r=>r.json()).then(g=>{ geo=g; buildMap(rows); });
    }
  }).catch(console.error);
}
function startAuto(){
  stopAuto();
  refreshAll();
  timer = setInterval(()=>refreshAll(), REFRESH_MS);
}
function stopAuto(){ if(timer){ clearInterval(timer); timer=null; } }

/* ===================== INIT ===================== */
document.addEventListener('DOMContentLoaded',()=>{
  // Arranca en portada ya activada; el auto-refresh se enciende al entrar a dashboard
});
</script>

</body>
</html>
