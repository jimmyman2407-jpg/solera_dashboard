<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Solera · Portada + Login + Dashboard (SPA)</title>

<!-- Leaflet (mapa) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Plotly (gráficas) -->
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

<!-- Fuente -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet"/>

<style>
  :root{
    /* Paleta y gradiente guía */
    --solera-grad: linear-gradient(90deg, rgb(60,0,130), rgb(100,20,200), rgb(156,54,255));
    --bg:#ffffff; --bg-2:#f6f8fc; --card:#ffffff; --ink:#0f172a; --muted:#6b7280; --grid:#e8ecf3;
    --shadow-lg: 0 30px 80px rgba(20,12,60,.18);
    --shadow-md: 0 18px 50px rgba(20,12,60,.10);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}

  /* ===== Router SPA ===== */
  [data-route]{display:none;min-height:100vh}
  [data-route].active{display:block}

  /* ===== PORTADA (/#) ===== */
  .hero{min-height:100vh;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;padding:40px 24px}
  .watermark{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;user-select:none;
    font-weight:900;text-transform:uppercase;letter-spacing:8px;color:#e5e7eb;opacity:.75;line-height:1;font-size:240px;white-space:nowrap;transform:translateY(6%)}
  @media (max-width:1200px){ .watermark{font-size:200px} }
  @media (max-width:900px){  .watermark{font-size:160px; transform:translateY(8%)} }
  @media (max-width:600px){  .watermark{font-size:120px; transform:translateY(10%)} }
  .hero-wrap{position:relative;z-index:1;max-width:980px;width:100%;display:flex;flex-direction:column;align-items:center;text-align:center}
  .hero h1{margin:0 0 18px;font-weight:900;letter-spacing:1px;line-height:1;text-transform:uppercase;font-size:64px;text-shadow:0 2px 0 rgba(255,255,255,.6)}
  @media (max-width:900px){ .hero h1{font-size:48px} }
  @media (max-width:600px){ .hero h1{font-size:38px} }
  .hero .sub{color:var(--muted);max-width:640px}
  .visual{margin:18px 0 24px;max-width:520px;width:100%;filter:drop-shadow(0 18px 40px rgba(0,0,0,.12))}
  .visual img{width:100%;height:auto;display:block;object-fit:contain;border-radius:16px}
  .cta{display:inline-flex;align-items:center;gap:10px;border:0;border-radius:12px;padding:12px 18px;color:#fff;cursor:pointer;
       background:var(--solera-grad);box-shadow:0 16px 40px rgba(78,0,150,.25);font-weight:800;letter-spacing:.3px;text-decoration:none}
  .cta:hover{transform:translateY(-1px)}

  /* ===== LOGIN (/#/login) ===== */
  .login-bg{background:var(--bg-2);display:flex;align-items:center;justify-content:center;padding:24px}
  .login-card{width:100%;max-width:420px;background:var(--card);border:1px solid var(--grid);border-radius:14px;padding:26px;box-shadow:0 16px 40px rgba(17,23,39,.08)}
  .login-card h3{margin:0 0 8px;font-weight:800}
  .login-card p{margin:0 0 16px;color:var(--muted)}
  label{display:block;font-size:13px;color:#374151;margin-bottom:6px}
  input{width:100%;padding:12px 14px;border:1px solid #e6e9ee;border-radius:8px;outline:none;margin-bottom:12px}
  input:focus{border-color:#cfd7ef;box-shadow:0 0 0 4px rgba(99,102,241,.12)}
  .row{display:flex;gap:10px;margin-top:6px}
  .btn{border:0;background:#111827;color:#fff;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:700;letter-spacing:.3px}
  .btn.secondary{background:#fff;color:#111827;border:1px solid var(--grid)}
  .error{display:none;color:#b00020;font-size:13px;margin-top:6px}

  /* ===== DASHBOARD (/#/dashboard) ===== */
  .wrap{max-width:1280px; margin:32px auto; padding:0 16px}
  .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:20px; margin-bottom:20px}
  .kpi{background:var(--card); border-radius:18px; padding:18px 22px; box-shadow:var(--shadow-md)}
  .kpi h6{margin:0 0 10px; font-weight:600; font-size:12px; letter-spacing:.08em; color:#6c7590}
  .kpi .name{font-weight:800; font-size:34px; line-height:1.05; margin:0; color:#0b1424}
  .kpi .number{font-weight:800; font-size:34px; line-height:1.1; margin:6px 0 0; color:#0b1424}

  .grid{display:grid; grid-template-columns: 1.2fr 1fr; gap:20px}
  .card{background:var(--card); border-radius:18px; box-shadow:var(--shadow-md); overflow:hidden}
  .card h5{margin:16px 16px 0; font-size:12px; font-weight:700; letter-spacing:.06em; color:#6c7590}
  #map{height:520px}

  .leaflet-tooltip{
    background:#11162f !important; color:#eef0fa !important;
    border:none !important; border-radius:10px !important; padding:8px 10px !important;
    box-shadow:0 10px 28px rgba(10,8,30,.22) !important;
  }
  .mx-legend{
    position:absolute; left:16px; bottom:16px; z-index:9999;
    background:#ffffff; border:1px solid var(--grid); border-radius:12px;
    padding:10px 12px; font:13px/1.25 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    box-shadow:0 14px 38px rgba(20,12,60,.16);
  }
  .mx-legend .bar{ width:160px; height:10px; border-radius:999px; margin:6px 0 4px; background:var(--solera-grad)}
  .mx-legend .ticks{ display:flex; justify-content:space-between; color:#556070}
  .plot{min-height:260px}
  .filterbar{display:flex; align-items:center; gap:10px; margin:10px 16px 0}
  .chip{font-size:12px; background:#eef2ff; color:#1e2f7a; padding:6px 10px; border-radius:999px}
  .btn-sm{border:0; background:#0f1129; color:#fff; padding:6px 10px; border-radius:8px; cursor:pointer}
  .btn-exit{background:#3b3f53}
  @media (max-width:1100px){
    .kpis{grid-template-columns:1fr 1fr}
    .grid{grid-template-columns:1fr}
    #map{height:400px}
  }
</style>
</head>
<body>

<!-- ============================
      PORTADA  (route "/")
============================= -->
<section data-route="/">
  <main class="hero">
    <div class="watermark">SOLERA</div>
    <div class="hero-wrap">
      <h1>SOLERA<br/>DASHBOARD KPI’S</h1>
      <p class="sub">Monitorea métricas clave con visualizaciones interactivas, filtros por estado y ranking de fabricantes.</p>
      <div class="visual">
        <!-- Asegúrate de que esta imagen exista en tu repo -->
        <img src="portadasolera.png" alt="Portada Solera">
      </div>
      <a class="cta" href="#/login">Ingresar</a>
    </div>
  </main>
</section>

<!-- ============================
      LOGIN  (route "/login")
============================= -->
<section data-route="/login" class="login-bg">
  <div class="login-card">
    <h3>Acceso al dashboard</h3>
    <p>Introduce tus credenciales para continuar.</p>
    <form onsubmit="return login(event)">
      <label for="user">Usuario</label>
      <input id="user" type="text" placeholder="usuario" required/>
      <label for="pass">Contraseña</label>
      <input id="pass" type="password" placeholder="contraseña" required/>
      <div class="row">
        <button class="btn" type="submit">Entrar</button>
        <a class="btn secondary" href="#/">Volver</a>
      </div>
      <div id="err" class="error">Usuario o contraseña incorrectos.</div>
    </form>
    <div style="font-size:12px;color:#999;margin-top:10px">Demo: usuario <b>admin</b> / contraseña <b>1234</b>.</div>
  </div>
</section>

<!-- ==================================
      DASHBOARD (route "/dashboard")
================================== -->
<section data-route="/dashboard" style="background:var(--bg-2)">
  <div class="wrap">

    <!-- KPIs -->
    <section class="kpis">
      <div class="kpi">
        <h6>ESTADO CON MAYOR NO. DE VALUACIONES</h6>
        <p class="name" id="kpi_estado_top_name">—</p>
        <p class="number" id="kpi_estado_top_val">—</p>
      </div>
      <div class="kpi">
        <h6>FABRICANTE CON MAYOR NO. DE VALUACIONES</h6>
        <p class="name" id="kpi_fab_top_name">—</p>
        <p class="number" id="kpi_fab_top_val">—</p>
      </div>
      <div class="kpi">
        <h6>ESTADO CON MAYOR PIEZAS SUSTITUIDAS</h6>
        <p class="name" id="kpi_estado_pzs_name">—</p>
        <p class="number" id="kpi_estado_pzs_val">—</p>
      </div>
      <div class="kpi">
        <h6>FABRICANTE CON MAYOR PIEZAS SUSTITUIDAS</h6>
        <p class="name" id="kpi_fab_pzs_name">—</p>
        <p class="number" id="kpi_fab_pzs_val">—</p>
      </div>
    </section>

    <!-- Mapa + 3 gráficas -->
    <section class="grid">
      <div class="card" style="position:relative">
        <h5>DETALLE POR ESTADO (MAPA)</h5>
        <div class="filterbar">
          <span class="chip">Filtro: <b id="state_badge">Todos</b></span>
          <button class="btn-sm" id="btn_clear">Quitar filtro</button>
          <a class="btn-sm btn-exit" href="#/login" style="margin-left:auto">Salir</a>
        </div>
        <div id="map"></div>
      </div>

      <div class="card">
        <h5>TOP FABRICANTES · NO DE VALUACIONES</h5>
        <div id="plot_val" class="plot"></div>
        <h5 style="margin-top:8px">TOP FABRICANTES · PIEZAS SUSTITUIDAS</h5>
        <div id="plot_pzs" class="plot"></div>
        <h5 style="margin-top:8px">TOP FABRICANTES · COSTO MEDIO POR PIEZA</h5>
        <div id="plot_costo" class="plot"></div>
      </div>
    </section>
  </div>
</section>

<script>
/* =========================
   Router SPA muy simple
========================= */
const routes = {
  '/': document.querySelector('[data-route="/"]'),
  '/login': document.querySelector('[data-route="/login"]'),
  '/dashboard': document.querySelector('[data-route="/dashboard"]')
};
function showRoute(path){
  Object.values(routes).forEach(n => n.classList.remove('active'));
  (routes[path] || routes['/']).classList.add('active');

  // Hooks
  if(path==='/dashboard') onActivateDashboard();
}
function parseHash(){ 
  const h = location.hash.replace(/^#/, '') || '/';
  return h.startsWith('/') ? h : `/${h}`;
}
window.addEventListener('hashchange', ()=>showRoute(parseHash()));
showRoute(parseHash());

/* =========================
   Login (demo front)
========================= */
function login(e){
  e.preventDefault();
  const u=document.getElementById('user').value.trim();
  const p=document.getElementById('pass').value.trim();
  if(u==='admin' && p==='1234'){
    location.hash = '/dashboard';
  }else{
    const err=document.getElementById('err');
    err.style.display='block';
    setTimeout(()=>err.style.display='none',3000);
  }
  return false;
}

/* =========================
   Dashboard: datos + UI
========================= */
const SHEET_PUBHTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTY8caVTcwnisoepB9R_rBQ2DAKlmxpTfA3WYqgaZQF2I2J2abE68cyJWvyd9Byu8QOP-N0nwOHWQ2K/pubhtml";
const GEO_URL = "https://raw.githubusercontent.com/angelnmara/geojson/master/mexicoHigh.json";

const ALIAS = {
  "DISTRITO FEDERAL":"CIUDAD DE MEXICO","CDMX":"CIUDAD DE MEXICO","CIUDAD DE MEXICO":"CIUDAD DE MEXICO",
  "ESTADO DE MEXICO":"MEXICO","MEXICO":"MEXICO","COAHUILA DE ZARAGOZA":"COAHUILA",
  "QUERETARO ARTEAGA":"QUERETARO","QUERETARO DE ARTEAGA":"QUERETARO",
  "MICHOACAN DE OCAMPO":"MICHOACAN","VERACRUZ DE IGNACIO DE LA LLAVE":"VERACRUZ",
  "SAN LUIS POTOSI":"SAN LUIS POTOSI","NUEVO LEON":"NUEVO LEON","YUCATAN":"YUCATAN",
};
const PSEUDO = new Set(["NO DISPONIBLE","SIN CODIGO POSTAL","SIN CODIGO"]);

const norm = s => String(s||"").normalize("NFD").replace(/\p{Mn}/gu,"").replace(/\s+/g," ").trim().toUpperCase();
const fmtI = x => Number(x||0).toLocaleString("es-MX");
const soleraGrad = t => {
  const stops = [[60,0,130],[100,20,200],[156,54,255]];
  const p = t*(stops.length-1), i = Math.floor(p), f = Math.min(1,p-i);
  const a = stops[i], b = stops[Math.min(i+1,stops.length-1)];
  const c = a.map((v,k)=>Math.round(v+(b[k]-v)*f));
  return `rgb(${c[0]},${c[1]},${c[2]})`;
};

let rawRows = [];
let selectedState = null;
let geo = null;
let map=null, layer=null;
let dashBootstrapped = false;

function coerceNumber(s){
  if(s==null) return 0;
  let v=String(s).trim().replace(/\s|\$/g,"");
  if(v.includes(",") && v.includes(".")){
    if(v.lastIndexOf(",")>v.lastIndexOf(".")){ v=v.replace(/\./g,"").replace(",","."); }
    else{ v=v.replace(/,/g,""); }
  }else if(v.includes(",") && !v.includes(".")){
    v=v.replace(/\./g,"").replace(",",".");
  }
  const n = Number(v); return Number.isFinite(n)?n:0;
}

function prepareRows(rows){
  return rows.map(r=>{
    const st = ALIAS[norm(r["Estado"])] || norm(r["Estado"]);
    return {
      EstadoKey: st,
      Estado: r["Estado"],
      Fabricante: String(r["Fabricante"]||"").trim(),
      NoVal: coerceNumber(r["No Valuaciones"]),
      Pzs:   coerceNumber(r["Piezas Sustituidas"]),
      Costo: coerceNumber(r["Costo Medio Pieza"])
    };
  }).filter(r => r.Fabricante!=="" && !PSEUDO.has(r.EstadoKey));
}

function groupSum(arr, key){
  const m=new Map();
  for(const a of arr){
    const k=a[key]; const got=m.get(k)||{key:k, NoVal:0, Pzs:0, CostoSum:0, Cnt:0};
    got.NoVal += a.NoVal; got.Pzs += a.Pzs; got.CostoSum += a.Costo; got.Cnt += 1;
    m.set(k,got);
  }
  return [...m.values()];
}
function aggregate(rows, stateFilter=null){
  const base = stateFilter ? rows.filter(r=>r.EstadoKey===stateFilter) : rows.slice();

  const estA = groupSum(base,"EstadoKey")
               .map(x=>({Estado:x.key, NoVal:x.NoVal, Pzs:x.Pzs}));
  const fabA = groupSum(base,"Fabricante")
               .map(x=>({Fabricante:x.key, NoVal:x.NoVal, Pzs:x.Pzs, CostoProm: x.Cnt? x.CostoSum/x.Cnt : 0}));

  // KPIs
  const estTopVal = estA.slice().sort((a,b)=>b.NoVal-a.NoVal)[0] || {Estado:"—", NoVal:0};
  const estTopPzs = estA.slice().sort((a,b)=>b.Pzs-a.Pzs)[0] || {Estado:"—", Pzs:0};
  const fabTopVal = fabA.slice().sort((a,b)=>b.NoVal-a.NoVal)[0] || {Fabricante:"—", NoVal:0};
  const fabTopPzs = fabA.slice().sort((a,b)=>b.Pzs-a.Pzs)[0] || {Fabricante:"—", Pzs:0};

  return {estA, fabA, estTopVal, estTopPzs, fabTopVal, fabTopPzs};
}

function renderKPIs(rows){
  const {estTopVal, estTopPzs, fabTopVal, fabTopPzs} = aggregate(rows, selectedState);

  document.getElementById("kpi_estado_top_name").textContent = estTopVal.Estado;
  document.getElementById("kpi_estado_top_val").textContent  = fmtI(estTopVal.NoVal);

  document.getElementById("kpi_fab_top_name").textContent    = fabTopVal.Fabricante;
  document.getElementById("kpi_fab_top_val").textContent     = fmtI(fabTopVal.NoVal);

  document.getElementById("kpi_estado_pzs_name").textContent = estTopPzs.Estado;
  document.getElementById("kpi_estado_pzs_val").textContent  = fmtI(estTopPzs.Pzs);

  document.getElementById("kpi_fab_pzs_name").textContent    = fabTopPzs.Fabricante;
  document.getElementById("kpi_fab_pzs_val").textContent     = fmtI(fabTopPzs.Pzs);
}

const PLOT_THEME = {
  template:{
    layout:{
      paper_bgcolor:"#fff", plot_bgcolor:"#fff",
      font:{family:"Inter, system-ui, Segoe UI, Roboto, Arial", color:"#0f172a", size:13},
      xaxis:{gridcolor:"#e8ecf3", zeroline:false, linecolor:"#e2e6f0", ticks:'outside'},
      yaxis:{gridcolor:"#e8ecf3", zeroline:false, linecolor:"#e2e6f0"},
      margin:{l:90, r:18, t:16, b:40},
      hoverlabel:{bgcolor:"#11162f", font:{color:"#eef0fa", size:12}, bordercolor:"#11162f"}
    }
  },
  showlegend:false
};
function bars(container, data, xKey, title){
  const top = data.slice().sort((a,b)=>b[xKey]-a[xKey]).slice(0,15);
  const y = top.map(d=>d.Fabricante);
  const x = top.map(d=>d[xKey]);
  const n = Math.max(1, x.length);
  const colors = x.map((_,i)=> i===0 ? "#ffbf3c" : soleraGrad(i/(n-1)));
  Plotly.newPlot(container,[{
    type:"bar", orientation:"h", x, y,
    marker:{color:colors, line:{color:"rgba(0,0,0,.08)", width:1}},
    hovertemplate:`<b>%{y}</b><br>${title}: %{x:,}<extra></extra>`
  }], PLOT_THEME, {displayModeBar:false, responsive:true});
}
function renderBars(rows){
  const {fabA} = aggregate(rows, selectedState);
  bars("plot_val",  fabA, "NoVal", "No de Valuaciones");
  bars("plot_pzs",  fabA, "Pzs",   "Piezas Sustituidas");

  const cost = fabA.filter(f=>Number.isFinite(f.CostoProm))
                   .map(f=>({...f, CostoProm:Math.round(f.CostoProm)}))
                   .sort((a,b)=>b.CostoProm-a.CostoProm).slice(0,15);
  const y = cost.map(d=>d.Fabricante);
  const x = cost.map(d=>d.CostoProm);
  const n = Math.max(1,x.length);
  const colors = x.map((_,i)=> i===0 ? "#58d1ff" : soleraGrad(i/(n-1)));
  Plotly.newPlot("plot_costo",[{
    type:"bar", orientation:"h", x, y,
    marker:{color:colors, line:{color:"rgba(0,0,0,.08)", width:1}},
    hovertemplate:"<b>%{y}</b><br>Costo medio: %{x:,}<extra></extra>"
  }], PLOT_THEME, {displayModeBar:false, responsive:true});
}

function buildMap(rows){
  if(!map){
    map = L.map("map",{zoomControl:true, attributionControl:false}).setView([23.5,-102],5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}).addTo(map);
  }
  if(layer){ layer.remove(); layer=null; }

  const {estA} = aggregate(rows);
  const dict = Object.fromEntries(estA.map(e=>[e.Estado, e]));

  geo.features.forEach(f=>{
    const k = ALIAS[norm(f.properties.name)] || norm(f.properties.name);
    f.properties.STATE_KEY = k;
    f.properties.NoVal = dict[k]?.NoVal || 0;
    f.properties.Pzs   = dict[k]?.Pzs   || 0;
  });

  const vals = geo.features.map(f=>f.properties.NoVal).sort((a,b)=>a-b);
  const q = p => vals.length ? vals[Math.min(vals.length-1, Math.floor(p*(vals.length-1)))] : 0;
  const qs = [q(.2), q(.4), q(.6), q(.8)];
  const toClass = v => (v<=qs[0])?0:(v<=qs[1])?1:(v<=qs[2])?2:(v<=qs[3])?3:4;

  layer = L.geoJSON(geo,{
    style: f=>{
      const idx = toClass(f.properties.NoVal);
      const color = soleraGrad(idx/4);
      return { fillColor:color, color:"#3b3f53", weight:0.9, fillOpacity:.96 };
    },
    onEachFeature: (f, lyr)=>{
      const k=f.properties.STATE_KEY;
      const html = `
        <div style="font-weight:800;margin-bottom:4px">${f.properties.name}</div>
        <div style="font-size:12px;color:#cbd5e1">
          No. Valuaciones: <b>${fmtI(dict[k]?.NoVal??0)}</b><br/>
          Piezas Sustituidas: <b>${fmtI(dict[k]?.Pzs??0)}</b>
        </div>`;
      lyr.bindTooltip(html,{sticky:true});
      lyr.on("click",()=>{
        selectedState = k;
        document.getElementById("state_badge").textContent = k;
        renderKPIs(rawRows); renderBars(rawRows);
      });
      lyr.on("mouseover",()=>lyr.setStyle({weight:2.2, color:"#11162f", fillOpacity:.99}));
      lyr.on("mouseout", ()=>lyr.setStyle({weight:0.9, color:"#3b3f53", fillOpacity:.96}));
    }
  }).addTo(map);

  const old=document.querySelector(".mx-legend"); if(old) old.remove();
  const legend=document.createElement("div");
  legend.className="mx-legend";
  legend.innerHTML=`
    <div style="font-weight:700;font-size:12px;color:#2b2f4b">Intensidad (valuaciones)</div>
    <div class="bar"></div>
    <div class="ticks">
      <span>${fmtI(qs[0])}</span><span>${fmtI(qs[2])}</span><span>${fmtI(qs[3])}</span>
    </div>`;
  document.getElementById("map").appendChild(legend);
}

async function readSheet(){
  try{
    const csv = await fetch(SHEET_PUBHTML.replace("/pubhtml","/pub?output=csv")).then(r=>r.text());
    if(csv.trim().length>0) return csvToRows(csv);
  }catch{}
  try{
    const html = await fetch(SHEET_PUBHTML).then(r=>r.text());
    const gids = [...html.matchAll(/gid=(\d+)/g)].map(m=>m[1]);
    for(const gid of gids){
      const u = SHEET_PUBHTML.replace("/pubhtml",`/pub?gid=${gid}&single=true&output=csv`);
      const t = await fetch(u).then(r=>r.text());
      if(t.trim().length>0) return csvToRows(t);
    }
  }catch{}
  throw new Error("No pude leer el Sheet.");
}
function csvToRows(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
  const head = lines.shift().split(",");
  const rows = lines.map(l=>{
    const cols = splitCSV(l);
    const obj = {}; head.forEach((h,i)=> obj[h]=cols[i]); return obj;
  });
  return rows;
}
function splitCSV(line){
  const out=[]; let cur="", q=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c==='\"'){ q=!q; continue; }
    if(c===',' && !q){ out.push(cur); cur=""; continue; }
    cur+=c;
  }
  out.push(cur); return out;
}

/* Hook al entrar a la ruta /dashboard */
function onActivateDashboard(){
  if(!dashBootstrapped){
    // Botón limpiar filtro
    const clearBtn = document.getElementById("btn_clear");
    if(clearBtn && !clearBtn.__wired){
      clearBtn.addEventListener("click", ()=>{
        selectedState=null; document.getElementById("state_badge").textContent="Todos";
        renderKPIs(rawRows); renderBars(rawRows); buildMap(rawRows);
      });
      clearBtn.__wired = true;
    }

    // Primera carga
    (async ()=>{
      try{
        const [rowsRaw, gjson] = await Promise.all([
          readSheet(), fetch(GEO_URL).then(r=>r.json())
        ]);
        geo = gjson;
        rawRows = prepareRows(rowsRaw);
        renderKPIs(rawRows);
        renderBars(rawRows);
        buildMap(rawRows);
        dashBootstrapped = true;
      }catch(e){
        console.error(e);
        alert("No pude cargar datos del Sheet o el GeoJSON. Revisa que el Sheet esté 'Publicado en la Web'.");
      }
    })();
  }else{
    // Si ya estaba inicializado, refresca vistas (por si venimos de otra ruta)
    renderKPIs(rawRows);
    renderBars(rawRows);
    buildMap(rawRows);
  }
}
</script>
</body>
</html>
